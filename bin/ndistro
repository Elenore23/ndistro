#!/usr/bin/env bash

#
# nDistro - Node distribution manager
# 
# Copyright (c) 2010 - TJ Holowaychuk <tj@vision-media.ca>
# Licensed MIT.
#

# Library version

VERSION="0.0.2"
ROOT=$(pwd)
BIN_URL="http://github.com/visionmedia/nodes/raw/master"
BIN_VERSION=
GET=

# wget support
which wget > /dev/null && GET="wget -q -O-"

# curl support
which curl > /dev/null && GET="curl -# -L"

#
# Exit with the given <msg ...>
#

abort() {
  echo "Error: $@" && exit 1
}

# Ensure we have curl or wget

[[ $GET ]] || abort "curl or wget required"

#
# Log the given <msg ...>
#

log() {
  echo "... $@"
}

#
# Install <user> <mod> [version]
#

module() {
  local user=$1
  local mod=$2
  local version=${3-master}
  local dest="$ROOT/modules/$mod"
  local url="http://github.com/$user/$mod/tarball/$version"
  if [[ -d $dest ]]; then
    log "already installed $mod"
  else
    if [[ $version = "master" ]]; then
      log "installing $mod"
    else
      log "installing $mod $version"
    fi
    mkdir -p $dest
    cd $dest \
      && $GET $url \
      | tar -xz --strip 1 \
      && cd ../.. \
      && bin $mod \
      && lib $mod
  fi
}

#
# Install <mod> binaries.
#
#  - alters shebang to $ROOT/bin/node
#

bin() {
  if [[ -d $ROOT/modules/$mod/bin ]]; then
    cd $ROOT/bin
    for bin in ../modules/$mod/bin/*; do
      local name=${bin##*/}
      log "installing bin/$name"
      local shebang=$(head -n 1 $bin)
      if [[ $shebang = "#!/usr/bin/env node" ]]; then
        sed "s|/usr/bin/env node|$ROOT/bin/node|" $bin \
          > ./$name \
          && chmod 0755 ./$name 
      else
        ln -sf $bin ./$name
      fi
    done
    cd ..
  fi
}

#
# Install <mod> library.
#
lib() {
  if [[ -d $ROOT/modules/$mod/lib ]]; then
    mkdir -p $ROOT/lib/node && cd $ROOT/lib/node
    ln -sf ../../modules/$mod/lib/* ./
    cd ../..
  fi
}

#
# Detect which node binary to install of the given <version>.
#

install_node_detect() {
  local version=$1
  local name=$(uname)
  case $name in
    Darwin)
      install_node $version osx
      ;;
    Linux)
      install_node $version linux
      ;;
    *)
      abort "Cannot find node binary for $name."
      ;;
  esac
}

#
# Install node binary <version> <sys>
#

install_node() {
  if [[ -f $ROOT/bin/node ]]; then
    log "already installed node"
  else
    local version=$1
    local sys=$2
    local url="$BIN_URL/$version-$sys"
    log "installing node $version"
    $GET $url > bin/node && chmod 0755 bin/node
  fi
}

#
# Set node <version>.
#

node() {
  BIN_VERSION=$1
}

#
# Install distro.
#

install() {
  mkdir -p $ROOT/bin
  if [[ -f $ROOT/.ndistro ]]; then
    . $ROOT/.ndistro
    install_node_detect $BIN_VERSION
    log "installation complete"
  else
    abort ".ndistro not found in this directory"
  fi
}

#
# Output usage information.
# 

usage() {
  cat <<-HELP

Usage: ndistro [options] [cmd]

Commands:

  edit   Opens CWD/.ndistro in $EDITOR

Options:

-V, --version   Output version number
-h, --help      Output help information

HELP
}

# Handle arguments

case $1 in
  -h|--help)
    usage && exit 1
    ;;
  -V|--version)
    echo $VERSION && exit 1
    ;;
  edit)
    $EDITOR $ROOT/.ndistro
    ;;
  *)
    install
    ;;
esac
