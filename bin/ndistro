#!/usr/bin/env bash

#
# nDistro - Node distribution manager
# 
# Copyright (c) 2010 - TJ Holowaychuk <tj@vision-media.ca>
# Licensed MIT.
#

# Library version

VERSION="0.0.1"
BIN_URL="http://github.com/creationix/ivy-bin/raw/master/node-"

#
# Exit with the given <msg ...>
#

abort() {
  echo "Error: $@" && exit 1
}

#
# Log the given <msg ...>
#

log() {
  echo "... $@"
}

#
# Install <user> <mod> [version]
#

mod() {
  local user=$1
  local mod=$2
  local version=${3-master}
  local dest="./modules/$mod"
  local url="http://github.com/$user/$mod/tarball/$version"
  if [[ $version = "master" ]]; then
    log "installing $user/$mod"
  else
    log "installing $user/$mod $version"
  fi
  mkdir -p $dest
  cd $dest \
    && curl -# -L $url \
    | tar -xz --strip 1 \
    && cd ../.. \
    && bin $mod \
    && lib $mod
}

#
# Install <mod> binaries.
#

bin() {
  if [[ -d ./modules/$mod/bin ]]; then
    cd bin
    ln -sf ../modules/$mod/bin/* ./
    cd ..
  fi
}

#
# Install <mod> library.
#
lib() {
  if [[ -d ./modules/$mod/lib ]]; then
    mkdir -p lib/node && cd lib/node
    ln -sf ../../modules/$mod/lib/* ./
    cd ../..
  fi
}

#
# Detect which node binary to install.
#

node() {
  local name=$(uname)
  case $name in
    Darwin)
      install_node osx
      ;;
    Linux)
      install_node linux
      ;;
    *)
      abort "Cannot find node binary for $name."
      ;;
  esac
}

#
# Install node binary <name>
#

install_node() {
  mkdir -p bin
  local url=$BIN_URL$1
  log "installing $url"
  curl -# -L $url > bin/node && chmod 0755 bin/node
}

# Load ./ndistro

if [[ -f ./.ndistro ]]; then
  node
  . ./.ndistro
else
  abort ".ndistro not found in this directory"
fi

